name: Deploy to Koyeb

on:
  workflow_run:
    workflows:
      - Build Image
    types:
      - completed
  workflow_dispatch:
    inputs:
      image_tag:
        description: Docker image tag to deploy (defaults to the triggering commit)
        required: false
        type: string

env:
  DOCKER_IMAGE_REPO: diegueins680/tdf-hq
  KOYEB_APP: ${{ secrets.KOYEB_APP_NAME }}

jobs:
  deploy:
    if: ${{ github.event_name != 'workflow_run' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    steps:
      - name: Install Koyeb CLI
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq ca-certificates
          RELEASE_API="https://api.github.com/repos/koyeb/koyeb-cli/releases/latest"
          CANDIDATES=$(curl -fsSL "$RELEASE_API" | jq -r '.assets[].browser_download_url')
          LATEST_URL=""
          for pat in 'linux.*amd64.*\.tar\.gz' 'linux.*x86_64.*\.tar\.gz' 'Linux_x86_64\.tar\.gz' 'linux-amd64\.tar\.gz' 'linux-x86_64\.tar\.gz'; do
            LATEST_URL=$(echo "$CANDIDATES" | grep -iE "$pat" | head -n1 || true)
            [ -n "$LATEST_URL" ] && break
          done
          if [ -z "$LATEST_URL" ]; then
            LATEST_URL=$(echo "$CANDIDATES" | grep -iE 'linux.*\.tar\.gz' | head -n1 || true)
          fi
          if [ -z "$LATEST_URL" ] || [ "$LATEST_URL" = "null" ]; then
            echo "Failed to resolve Koyeb CLI download URL" >&2
            exit 1
          fi
          echo "Downloading Koyeb CLI from $LATEST_URL"
          curl -fsSL "$LATEST_URL" -o /tmp/koyeb.tar.gz
          tar -xzf /tmp/koyeb.tar.gz -C /tmp
          BIN_PATH=$(find /tmp -maxdepth 2 -type f -name 'koyeb*' | head -n1 || true)
          if [ -z "$BIN_PATH" ]; then
            echo "Koyeb binary not found after extraction" >&2
            exit 1
          fi
          sudo install "$BIN_PATH" /usr/local/bin/koyeb
          /usr/local/bin/koyeb version
      - name: Deploy image to Koyeb
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
          KOYEB_SERVICE: ${{ secrets.KOYEB_SERVICE_NAME }}
          KOYEB_DOCKER_REGISTRY_SECRET: ${{ secrets.KOYEB_DOCKER_REGISTRY_SECRET }}
          EVENT_NAME: ${{ github.event_name }}
          WORKFLOW_SHA: ${{ github.event.workflow_run.head_sha }}
          FALLBACK_SHA: ${{ github.sha }}
          INPUT_IMAGE_TAG: ${{ github.event.inputs.image_tag }}
        run: |
          set -euo pipefail
          IMAGE_TAG="$INPUT_IMAGE_TAG"
          if [ -z "$IMAGE_TAG" ]; then
            if [ "$EVENT_NAME" = "workflow_run" ]; then
              IMAGE_TAG="$WORKFLOW_SHA"
            else
              IMAGE_TAG="$FALLBACK_SHA"
            fi
          fi
          if [ -z "$IMAGE_TAG" ]; then
            echo "Image tag could not be resolved." >&2
            exit 1
          fi
          export DOCKER_IMAGE_TAG="$IMAGE_TAG"
          slugify() {
            echo "$1" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g; s/-{2,}/-/g'
          }
          retry() {
            local max="$1"
            shift
            local attempt=1
            local delay=10
            while true; do
              if "$@"; then
                return 0
              fi
              if [ "$attempt" -ge "$max" ]; then
                echo "Command failed after $attempt attempts: $*" >&2
                return 1
              fi
              echo "Retrying ($attempt/$max) in ${delay}s: $*" >&2
              sleep "$delay"
              attempt=$((attempt + 1))
              delay=$((delay * 2))
            done
          }
          if [ -z "${KOYEB_TOKEN:-}" ] || [ -z "${KOYEB_SERVICE:-}" ] || [ -z "${KOYEB_APP:-}" ]; then
            echo "KOYEB_API_TOKEN, KOYEB_SERVICE_NAME, and KOYEB_APP_NAME secrets are required" >&2
            exit 1
          fi
          APP_NAME=$(slugify "$KOYEB_APP")
          SERVICE_NAME=$(slugify "$KOYEB_SERVICE")
          if [ -z "$APP_NAME" ] || [ -z "$SERVICE_NAME" ]; then
            echo "Koyeb app/service names resolved to empty after slugify; please set KOYEB_APP_NAME / KOYEB_SERVICE_NAME to alphanumeric or dash." >&2
            exit 1
          fi
          DOCKER_SECRET_ARGS=()
          if [ -n "${KOYEB_DOCKER_REGISTRY_SECRET:-}" ]; then
            DOCKER_SECRET_ARGS=(--docker-private-registry-secret "$KOYEB_DOCKER_REGISTRY_SECRET")
          fi
          # Ensure app exists
          APP_ID=$(koyeb --token "$KOYEB_TOKEN" apps list --output json | jq -r '.apps[] | select(.name=="'"$APP_NAME"'") | .id' | head -n1)
          if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
            echo "Koyeb app '$APP_NAME' not found; creating it..."
            koyeb --token "$KOYEB_TOKEN" apps create "$APP_NAME"
            APP_ID=$(koyeb --token "$KOYEB_TOKEN" apps list --output json | jq -r '.apps[] | select(.name=="'"$APP_NAME"'") | .id' | head -n1)
            if [ -z "$APP_ID" ] || [ "$APP_ID" = "null" ]; then
              echo "Failed to create/resolve Koyeb app '$APP_NAME'" >&2
              exit 1
            fi
          fi

          # Deploy image: update existing service if present, otherwise create it.
          EXISTING_ID=$(koyeb --token "$KOYEB_TOKEN" services list --app "$APP_ID" --output json | jq -r '.services[] | select(.name=="'"$SERVICE_NAME"'") | .id')
          if [ -n "$EXISTING_ID" ] && [ "$EXISTING_ID" != "null" ]; then
            echo "Updating existing service $SERVICE_NAME ($EXISTING_ID) with image ${DOCKER_IMAGE_REPO}:${DOCKER_IMAGE_TAG}"
            retry 6 koyeb --token "$KOYEB_TOKEN" services update "$EXISTING_ID" \
              --docker "${DOCKER_IMAGE_REPO}:${DOCKER_IMAGE_TAG}" \
              --ports 8080:http \
              --strategy rolling \
              "${DOCKER_SECRET_ARGS[@]}"
          else
            echo "Creating service $SERVICE_NAME in app $APP_NAME with image ${DOCKER_IMAGE_REPO}:${DOCKER_IMAGE_TAG}"
            retry 6 koyeb --token "$KOYEB_TOKEN" services create "$SERVICE_NAME" \
              --app "$APP_ID" \
              --docker "${DOCKER_IMAGE_REPO}:${DOCKER_IMAGE_TAG}" \
              --ports 8080:http \
              --strategy rolling \
              "${DOCKER_SECRET_ARGS[@]}"
          fi
