name: upload-youtube
on:
  repository_dispatch:
    types: [upload_youtube]

jobs:
  upload:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install --upgrade google-api-python-client google-auth-oauthlib google-auth-httplib2 google-auth tqdm gdown requests jq

      - name: Download video & thumbnail from Google Drive
        run: |
          gdown --id "${{ github.event.client_payload.video_file_id }}" -O video.mp4
          if [ -n "${{ github.event.client_payload.thumb_file_id }}" ]; then
            gdown --id "${{ github.event.client_payload.thumb_file_id }}" -O thumb.jpg || true
          fi

      - name: Upload to YouTube (resumable)
        env:
          YT_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: |
          python github/scripts/youtube_upload.py \
            --file "video.mp4" \
            --title "${{ github.event.client_payload.title }}" \
            --description "${{ github.event.client_payload.description }}" \
            --tags "${{ github.event.client_payload.tags }}" \
            --categoryId "10" \
            --language "es" \
            --privacyStatus "private" \
            --publishAt "${{ github.event.client_payload.publish_at }}" \
            --playlistId "${{ github.event.client_payload.playlist_id }}" \
            --thumbnail "thumb.jpg" \
            --madeForKids "false" \
            --out "yt_out.json"

      - name: Parse output
        id: parse
        run: |
          echo "video_id=$(jq -r '.videoId' yt_out.json)" >> $GITHUB_OUTPUT
          echo "video_url=$(jq -r '.videoUrl' yt_out.json)" >> $GITHUB_OUTPUT

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python github/scripts/notify_discord.py \
            --status "${{ job.status }}" \
            --video-url "${{ steps.parse.outputs.video_url }}" \
            --context "${{ github.event.client_payload.context }}"

      - name: Callback backend (optional)
        if: always()
        env:
          BACKEND_CALLBACK_URL: ${{ secrets.BACKEND_CALLBACK_URL }}
          BACKEND_TOKEN: ${{ secrets.BACKEND_TOKEN }}
        run: |
          python - << 'PY'
import os, requests, json
url = os.environ.get("BACKEND_CALLBACK_URL")
tok = os.environ.get("BACKEND_TOKEN")
payload = {
  "projectId": int("${{ github.event.client_payload.project_id }}"),
  "status": "${{ job.status }}",
  "videoId": "${{ steps.parse.outputs.video_id }}",
  "videoUrl": "${{ steps.parse.outputs.video_url }}"
}
headers={"Authorization": f"Bearer {tok}"} if tok else {}
if url:
  try:
    r = requests.post(url, json=payload, headers=headers, timeout=30)
    print(r.status_code, r.text)
  except Exception as e:
    print("Callback failed:", e)
PY
